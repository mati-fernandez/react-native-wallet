name: Keep Render Alive

on:
  workflow_dispatch: # manual trigger
  schedule:
    - cron: '*/5 * * * *' # cada 5 minutos (UTC)(GHA puede demorar mÃ¡s, por eso 5min)

jobs:
  ping-render:
    runs-on: ubuntu-latest
    steps:
      - name: Random delay
        run: |
          # Delay random entre 0 y 120 segundos (0-2 min)
          DELAY=$((RANDOM % 121))
          echo "Waiting $DELAY seconds..."
          sleep $DELAY

      - name: Ping Render backend
        run: |
          curl -X GET "https://react-native-wallet-g7l1.onrender.com/api/health" \
          -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:142.0) Gecko/20100101 Firefox/142.0" \
          -H "Accept: application/json" \
          -H "Accept-Language: en-US,en;q=0.9" \
          -H "Cache-Control: no-cache" \
          -H "Pragma: no-cache" 
          
      - name: GitHub Actions keepalive commit
        run: |
          FILE=".github/keepalive.txt"
          NOW=$(date +%s)
          LIMIT_DAYS=10
          LIMIT_SECONDS=$((LIMIT_DAYS * 24 * 60 * 60))

          if [ -f "$FILE" ]; then
            LAST=$(git log -1 --format=%ct -- "$FILE")
          else
            LAST=0
          fi

          DIFF=$((NOW - LAST))

          if [ "$DIFF" -ge "$LIMIT_SECONDS" ]; then
            echo "Keepalive update: $(date -u)" > "$FILE"

            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add "$FILE"
            git commit -m "GHA WF KA - GitHub Actions WorkFlow Keep Alive"
            git push
          else
            echo "Keepalive not needed yet"
          fi
